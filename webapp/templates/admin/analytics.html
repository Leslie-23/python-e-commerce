{% extends "admin/layout.html" %}
{% block title %}Analytics - PAL Store{% endblock %}
{% block breadcrumb %}
    <li class="breadcrumb-item"><a href="{{ url_for('admin_dashboard') }}">Dashboard</a></li>
    <li class="breadcrumb-item active">Analytics</li>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h1 class="h3 mb-0 text-gray-800">Advanced Analytics</h1>
            <div>
                <select class="form-select d-inline-block me-2" id="dateRange" style="width: auto;">
                    <option value="7">Last 7 days</option>
                    <option value="30" selected>Last 30 days</option>
                    <option value="90">Last 3 months</option>
                    <option value="365">Last year</option>
                </select>
                <button class="btn btn-primary" onclick="exportAnalytics()">
                    <i class="fas fa-download me-2"></i>Export Report
                </button>
            </div>
        </div>
        <p class="text-muted">Comprehensive insights into your store performance</p>
    </div>
</div>

<!-- Key Performance Indicators -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="stats-card">
            <div class="row no-gutters align-items-center">
                <div class="col mr-2">
                    <div class="stats-label mb-1">Total Revenue</div>
                    <div class="stats-number" id="totalRevenue">$0.00</div>
                    <div class="stats-change text-success" id="revenueChange">+0% from last period</div>
                </div>
                <div class="col-auto">
                    <i class="fas fa-dollar-sign stats-icon text-primary"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="stats-card">
            <div class="row no-gutters align-items-center">
                <div class="col mr-2">
                    <div class="stats-label mb-1">Orders</div>
                    <div class="stats-number" id="totalOrders">0</div>
                    <div class="stats-change text-info" id="ordersChange">+0% from last period</div>
                </div>
                <div class="col-auto">
                    <i class="fas fa-shopping-cart stats-icon text-success"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="stats-card">
            <div class="row no-gutters align-items-center">
                <div class="col mr-2">
                    <div class="stats-label mb-1">Average Order Value</div>
                    <div class="stats-number" id="avgOrderValue">$0.00</div>
                    <div class="stats-change text-warning" id="aovChange">+0% from last period</div>
                </div>
                <div class="col-auto">
                    <i class="fas fa-chart-line stats-icon text-warning"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="stats-card">
            <div class="row no-gutters align-items-center">
                <div class="col mr-2">
                    <div class="stats-label mb-1">Conversion Rate</div>
                    <div class="stats-number" id="conversionRate">0%</div>
                    <div class="stats-change text-danger" id="conversionChange">+0% from last period</div>
                </div>
                <div class="col-auto">
                    <i class="fas fa-percentage stats-icon text-info"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row 1 -->
<div class="row mb-4">
    <div class="col-xl-8">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Revenue Trends</h6>
            </div>
            <div class="card-body">
                <canvas id="revenueChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
    <div class="col-xl-4">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Sales by Category</h6>
            </div>
            <div class="card-body">
                <canvas id="categoryChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row 2 -->
<div class="row mb-4">
    <div class="col-xl-6">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Top Selling Products</h6>
            </div>
            <div class="card-body">
                <canvas id="topProductsChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
    <div class="col-xl-6">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Customer Acquisition</h6>
            </div>
            <div class="card-body">
                <canvas id="customerChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Advanced Analytics Tables -->
<div class="row mb-4">
    <div class="col-xl-6">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Product Performance</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered" id="productPerformanceTable">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Sales</th>
                                <th>Revenue</th>
                                <th>Conversion</th>
                            </tr>
                        </thead>
                        <tbody id="productPerformanceBody">
                            <!-- Data will be loaded via JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-6">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Customer Segments</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered" id="customerSegmentsTable">
                        <thead>
                            <tr>
                                <th>Segment</th>
                                <th>Customers</th>
                                <th>Avg. Order Value</th>
                                <th>Total Spent</th>
                            </tr>
                        </thead>
                        <tbody id="customerSegmentsBody">
                            <!-- Data will be loaded via JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Real-time Metrics -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary">Real-time Activity</h6>
                    <div class="text-success">
                        <i class="fas fa-circle me-1" style="font-size: 8px;"></i>Live
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="metric-box">
                            <div class="metric-label">Active Users</div>
                            <div class="metric-value" id="activeUsers">0</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-box">
                            <div class="metric-label">Page Views (Today)</div>
                            <div class="metric-value" id="pageViews">0</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-box">
                            <div class="metric-label">Cart Abandonment</div>
                            <div class="metric-value" id="cartAbandonment">0%</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-box">
                            <div class="metric-label">Orders Today</div>
                            <div class="metric-value" id="ordersToday">0</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Heatmap and Detailed Analytics -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary">Sales Heatmap</h6>
                    <div class="btn-group" role="group">
                        <input type="radio" class="btn-check" name="heatmapType" id="hourly" value="hourly" checked>
                        <label class="btn btn-outline-primary btn-sm" for="hourly">Hourly</label>
                        
                        <input type="radio" class="btn-check" name="heatmapType" id="daily" value="daily">
                        <label class="btn btn-outline-primary btn-sm" for="daily">Daily</label>
                        
                        <input type="radio" class="btn-check" name="heatmapType" id="weekly" value="weekly">
                        <label class="btn btn-outline-primary btn-sm" for="weekly">Weekly</label>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div id="salesHeatmap" style="height: 400px;">
                    <!-- Heatmap will be generated here -->
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Initialize charts and load data
document.addEventListener('DOMContentLoaded', function() {
    loadAnalyticsData();
    initializeCharts();
    startRealTimeUpdates();
});

// Chart instances
let revenueChart, categoryChart, topProductsChart, customerChart;

function loadAnalyticsData() {
    const dateRange = document.getElementById('dateRange').value;
    
    fetch(`/admin/analytics/data?days=${dateRange}`)
        .then(response => response.json())
        .then(data => {
            updateKPIs(data.kpis);
            updateCharts(data.charts);
            updateTables(data.tables);
        })
        .catch(error => {
            console.error('Error loading analytics data:', error);
        });
}

function updateKPIs(kpis) {
    document.getElementById('totalRevenue').textContent = `$${kpis.total_revenue.toFixed(2)}`;
    document.getElementById('totalOrders').textContent = kpis.total_orders;
    document.getElementById('avgOrderValue').textContent = `$${kpis.avg_order_value.toFixed(2)}`;
    document.getElementById('conversionRate').textContent = `${kpis.conversion_rate.toFixed(1)}%`;
    
    // Update change indicators
    updateChangeIndicator('revenueChange', kpis.revenue_change);
    updateChangeIndicator('ordersChange', kpis.orders_change);
    updateChangeIndicator('aovChange', kpis.aov_change);
    updateChangeIndicator('conversionChange', kpis.conversion_change);
}

function updateChangeIndicator(elementId, change) {
    const element = document.getElementById(elementId);
    const isPositive = change >= 0;
    const icon = isPositive ? 'up' : 'down';
    const colorClass = isPositive ? 'text-success' : 'text-danger';
    
    element.className = `stats-change ${colorClass}`;
    element.innerHTML = `<i class="fas fa-arrow-${icon} me-1"></i>${Math.abs(change).toFixed(1)}% from last period`;
}

function initializeCharts() {
    // Revenue Chart
    const revenueCtx = document.getElementById('revenueChart').getContext('2d');
    revenueChart = new Chart(revenueCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Revenue',
                data: [],
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '$' + value.toFixed(2);
                        }
                    }
                }
            }
        }
    });

    // Category Chart
    const categoryCtx = document.getElementById('categoryChart').getContext('2d');
    categoryChart = new Chart(categoryCtx, {
        type: 'doughnut',
        data: {
            labels: [],
            datasets: [{
                data: [],
                backgroundColor: [
                    '#FF6384',
                    '#36A2EB',
                    '#FFCE56',
                    '#4BC0C0',
                    '#9966FF',
                    '#FF9F40'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });

    // Top Products Chart
    const topProductsCtx = document.getElementById('topProductsChart').getContext('2d');
    topProductsChart = new Chart(topProductsCtx, {
        type: 'bar',
        data: {
            labels: [],
            datasets: [{
                label: 'Sales',
                data: [],
                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Customer Chart
    const customerCtx = document.getElementById('customerChart').getContext('2d');
    customerChart = new Chart(customerCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'New Customers',
                data: [],
                borderColor: 'rgb(255, 99, 132)',
                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

function updateCharts(chartData) {
    // Update Revenue Chart
    revenueChart.data.labels = chartData.revenue.labels;
    revenueChart.data.datasets[0].data = chartData.revenue.data;
    revenueChart.update();

    // Update Category Chart
    categoryChart.data.labels = chartData.categories.labels;
    categoryChart.data.datasets[0].data = chartData.categories.data;
    categoryChart.update();

    // Update Top Products Chart
    topProductsChart.data.labels = chartData.top_products.labels;
    topProductsChart.data.datasets[0].data = chartData.top_products.data;
    topProductsChart.update();

    // Update Customer Chart
    customerChart.data.labels = chartData.customers.labels;
    customerChart.data.datasets[0].data = chartData.customers.data;
    customerChart.update();
}

function updateTables(tableData) {
    // Update Product Performance Table
    const productBody = document.getElementById('productPerformanceBody');
    productBody.innerHTML = '';
    tableData.product_performance.forEach(product => {
        const row = `
            <tr>
                <td>${product.name}</td>
                <td>${product.sales}</td>
                <td>$${product.revenue.toFixed(2)}</td>
                <td>${product.conversion.toFixed(1)}%</td>
            </tr>
        `;
        productBody.innerHTML += row;
    });

    // Update Customer Segments Table
    const segmentsBody = document.getElementById('customerSegmentsBody');
    segmentsBody.innerHTML = '';
    tableData.customer_segments.forEach(segment => {
        const row = `
            <tr>
                <td>${segment.name}</td>
                <td>${segment.customers}</td>
                <td>$${segment.avg_order_value.toFixed(2)}</td>
                <td>$${segment.total_spent.toFixed(2)}</td>
            </tr>
        `;
        segmentsBody.innerHTML += row;
    });
}

function startRealTimeUpdates() {
    setInterval(() => {
        fetch('/admin/analytics/realtime')
            .then(response => response.json())
            .then(data => {
                document.getElementById('activeUsers').textContent = data.active_users;
                document.getElementById('pageViews').textContent = data.page_views;
                document.getElementById('cartAbandonment').textContent = `${data.cart_abandonment.toFixed(1)}%`;
                document.getElementById('ordersToday').textContent = data.orders_today;
            })
            .catch(error => {
                console.error('Error updating real-time data:', error);
            });
    }, 30000); // Update every 30 seconds
}

// Event listeners
document.getElementById('dateRange').addEventListener('change', loadAnalyticsData);

function exportAnalytics() {
    const dateRange = document.getElementById('dateRange').value;
    window.location.href = `/admin/analytics/export?days=${dateRange}`;
}
</script>

<style>
.stats-card {
    background: #fff;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
    border-left: 4px solid #4e73df;
}

.stats-label {
    font-size: 0.8rem;
    font-weight: 700;
    text-transform: uppercase;
    color: #5a5c69;
}

.stats-number {
    font-size: 1.25rem;
    font-weight: 700;
    color: #3a3b45;
}

.stats-change {
    font-size: 0.75rem;
    margin-top: 4px;
}

.stats-icon {
    font-size: 2rem;
    opacity: 0.3;
}

.metric-box {
    text-align: center;
    padding: 20px;
    border: 1px solid #e3e6f0;
    border-radius: 8px;
    background: #f8f9fc;
}

.metric-label {
    font-size: 0.875rem;
    color: #5a5c69;
    margin-bottom: 8px;
}

.metric-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: #3a3b45;
}

#salesHeatmap {
    background: #f8f9fc;
    border: 1px solid #e3e6f0;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #5a5c69;
}
</style>
{% endblock %}
